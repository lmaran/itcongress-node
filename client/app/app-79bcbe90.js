"use strict";var app=angular.module("itcongress",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","ui.select","ngAnimate","toastr"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,r){e.otherwise({redirectTo:"/admin"}),t.html5Mode(!0),r.interceptors.push("authInterceptor")}]),app.config(["toastrConfig",function(e){angular.extend(e,{positionClass:"toast-top-center"})}]),app.run(["$rootScope","$location","userService","$window",function(e,t,r,n){e.$on("$routeChangeStart",function(e,n,o){n.authenticate&&!r.isLoggedIn&&(e.preventDefault(),t.path("/login"))}),e.$on("$routeChangeSuccess",function(r,o,i){o.hasOwnProperty("$$route")&&(e.pageTitle=o.$$route.title),n.ga&&n.ga("send","pageview",{page:t.path(),title:e.pageTitle})}),e.goBack=function(){n.history.back()}}]),app.controller("customerEmployeeController",["$scope","$route","customerEmployeeService","$location","$q","helperValidator",function(e,t,r,n,o,i){function a(){c()}function c(){u=r.getById(t.current.params.id).then(function(t){e.customerEmployee=t})["catch"](function(e){alert(JSON.stringify(e,null,4))})}function l(e,t){var r="customerEmployee";i.setAllFildsAsValid(t),i.required50(e,t,r,"name"),i.optionalEmail(e,t,r,"email")}var u;e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.isActiveOptions=[{id:!0,name:"Da"},{id:!1,name:"Nu"}],e.customerEmployee={},e.errors={},e.isEditMode&&a(),e.create=function(t){return l(e,t),t.$invalid?!1:void r.create(e.customerEmployee).then(function(t){e.goBack()})["catch"](function(r){r.data.errors?i.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))})},e.update=function(t){return e.customerEmployee.askForNotification&&!e.customerEmployee.email?(alert("Ai ales sa notifici clientul dar lipseste adresa de email!"),!1):(l(e,t),t.$invalid?!1:void r.update(e.customerEmployee).then(function(t){e.goBack()})["catch"](function(r){r.data.errors?i.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))}))}}]),app.config(["$routeProvider",function(e){e.when("/admin/customerEmployees",{controller:"customerEmployeesController",templateUrl:"app/customerEmployee/customerEmployees.html",title:"Angajati client",reloadOnSearch:!1}).when("/admin/customerEmployees/create",{controller:"customerEmployeeController",templateUrl:"app/customerEmployee/customerEmployee.html",title:"Adauga angajat"}).when("/admin/customerEmployees/:id",{controller:"customerEmployeeController",templateUrl:"app/customerEmployee/customerEmployee.html",title:"Editeaza angajat",isEditMode:!0})}]),app.factory("customerEmployeeService",["$http",function(e){var t={},r="/api/customerEmployees/";return t.getByBadge=function(t){var n="?$filter=badgeCode eq '"+t+"' and isActive eq true";return e.get(r+n).then(function(e){return e.data})},t.create=function(t){return e.post(r,t)},t.getAll=function(){return e.get(r).then(function(e){return e.data})},t.getById=function(t){return e.get(r+encodeURIComponent(t)).then(function(e){return e.data})},t.update=function(t){return e.put(r,t)},t["delete"]=function(t){return e["delete"](r+encodeURIComponent(t))},t}]),app.controller("customerEmployeesController",["$scope","$location","customerEmployeeService","modalService",function(e,t,r,n){function o(){r.getAll().then(function(t){e.customerEmployees=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.customerEmployees=[],e.errors={},o(),e["delete"]=function(t){var o={bodyDetails:t.name};n.confirm(o).then(function(n){for(var o in e.customerEmployees)if(e.customerEmployees[o]._id===t._id)break;r["delete"](t._id).then(function(){e.customerEmployees.splice(o,1)})["catch"](function(t){e.errors=JSON.stringify(t.data,null,4),alert(e.errors)})})},e.create=function(){t.path("/admin/customerEmployees/create")},e.refresh=function(){o()},e.mySearch=function(t){var r=!1;return e.search?(new RegExp(e.search,"i").test(t.name)||new RegExp(e.search,"i").test(t.badgeCode))&&(r=!0):r=!0,r}}]),app.controller("createDeliveryTplController",["$scope","$uibModalInstance","helperService","deliveryService","helperValidator","$q","orderService","orderLineService","dataToModal",function(e,t,r,n,o,i,a,c,l){function u(){e.existNewSeries=!1,a.getEatSeriesList(e.selectedOrder._id).then(function(t){e.eatSeriesList=_.map(t,function(t){var r=!!_.some(l,{orderId:e.selectedOrder._id,eatSeries:t});return r||(e.existNewSeries=!0),{name:t,selected:!r,disabled:r}})})}e.errors={},e.noOrders=!1,e.eatSeriesList=[],e.delivery={},a.getAllOpen().then(function(t){e.orders=t,e.orders.length>0?(e.selectedOrder=t[0],u()):e.noOrders=!0})["catch"](function(e){alert(JSON.stringify(e,null,4))}),e.selectOrder=function(){u()},e.create=function(r){e.selectedOrder&&(e.delivery.orderId=e.selectedOrder._id,e.delivery.orderDate=e.selectedOrder.date),e.delivery.eatSeriesList=_.chain(e.eatSeriesList).filter({selected:!0}).map("name").sortBy().value(),n.createMany(e.delivery).then(function(e){t.close()})["catch"](function(e){})},e.cancel=function(){t.dismiss("cancel")}}]),app.controller("deliveriesController",["$scope","$location","deliveryService","modalService","helperService","$uibModal",function(e,t,r,n,o,i){function a(){r.getAll().then(function(t){e.deliveries=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.deliveries=[],e.errors={},a(),e["delete"]=function(t){var o={bodyDetails:t.name};n.confirm(o).then(function(n){var o=0;for(o in e.deliveries)if(e.deliveries[o]._id===t._id)break;r["delete"](t._id).then(function(){e.deliveries.splice(o,1)})["catch"](function(t){e.errors=JSON.stringify(t.data,null,4),alert(e.errors)})})},e.openCreateDelivery=function(){var t=i.open({animation:!1,templateUrl:"app/delivery/createDeliveryTpl.html",controller:"createDeliveryTplController",resolve:{dataToModal:function(){return e.deliveries}}});t.result.then(function(){e.refresh()},function(){})},e.refresh=function(){a()},e.dt=function(e){return o.getObjFromString(e)}}]),app.controller("deliveryController",["$scope","$route","deliveryService","$location","helperValidator","helperService","orderLineService","$uibModal","$timeout","menuService","toastr","customerEmployeeService","orderService",function(e,t,r,n,o,i,a,c,l,u,s,d,f){function p(){m()}function m(){r.getById(t.current.params.id).then(function(t){e.delivery=t,e.dateAsShortString=v(e.delivery.orderDate).dateAsShortString,g(e.delivery.orderDate),h(t.orderId,t.eatSeries)})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function h(t,r){f.getDeliverySummary(t,r).then(function(t){e.deliverySummary=t})["catch"](function(e){alert(JSON.stringify(e,null,4))})}function g(t){u.getMenu(t).then(function(t){e.menu=t[0]})["catch"](function(e){alert(JSON.stringify(e,null,4))})}function v(e){return i.getObjFromString(e)}function y(t){e.option1=_.find(e.menu.dishes,{option:t.option1}),e.option2=_.find(e.menu.dishes,{option:t.option2})}function S(e){var t=parseInt(e,10),r=t.toString(16),n=r.substr(0,r.length-4),o=r.substr(r.length-4);n.length>2&&(n=n.substr(n.length-2));var i=parseInt(n,16),a=parseInt(o,16),c=$(i,5),l=$(a,5);return c+l}function $(e,t){return Array(Math.max(t-String(e).length+1,0)).join("0")+e}e.isFocusOnName=!e.isEditMode,e.errors={},e.delivery={},e.preferences=["A","B","C","D"],e.selectedPreference="Toate pref.",e.deliverySummary={},e.obj={},e.obj.isFocusOnBadge=!0,p(),e.refresh=function(){p()},e.obj.onlyNoBadges=!1,e.openDeliveryLine=function(t,r){var n="app/delivery/openToCompleteTpl.html";"completed"===t.status&&(n="app/delivery/openToRevokeTpl.html"),y(t);var o=c.open({animation:!1,templateUrl:n,controller:"openDeliveryLineTplController",resolve:{dataToModal:function(){return{orderLine:t,option1:e.option1,option2:e.option2}}}});o.result.then(function(){"open"===r?e.refreshOpen():e.refreshCompleted()},function(){})};var M=function(){a.getOrderLinesBySeriesAndStatus(e.delivery.orderId,e.delivery.eatSeries,"open").then(function(t){e.orderLinesOpen=t})["catch"](function(e){alert(JSON.stringify(e,null,4))})};e.refreshOpen=function(){M()},e.selectTabOpen=function(){M()};var O=function(){a.getOrderLinesBySeriesAndStatus(e.delivery.orderId,e.delivery.eatSeries,"completed").then(function(t){e.orderLinesCompleted=_.orderBy(t,"deliveryDate","desc")})["catch"](function(e){alert(JSON.stringify(e,null,4))})};e.refreshCompleted=function(){O()},e.selectTabCompleted=function(e){O()},e.selectTab1=function(){e.obj.isFocusOnBadge=!0,e.orderLine=void 0,h(e.delivery.orderId,e.delivery.eatSeries)},e.deliverByBadge=function(t){if(e.orderLine=void 0,10!==e.obj.badgeCode.length||isNaN(e.obj.badgeCode))return e.errorValidation=!0,e.errorMessage="'"+e.obj.badgeCode+"' este un cod invalid! (nu are 10 cifre)",e.obj.badgeCode="",void(e.obj.isFocusOnBadge=!0);var n=S(e.obj.badgeCode);a.getOrderLinesByBadge(e.delivery.orderId,n).then(function(t){if(0===t.length){var o=e.obj.badgeCode;d.getByBadge(n).then(function(t){t.length>0?e.errorMessage="Lipsa comanda pt. "+o+" ("+n+") - "+t[0].name:e.errorMessage="Card negasit: "+o+" ("+n+")",e.errorValidation=!0;var i={orderDate:e.delivery.orderDate,series:e.delivery.eatSeries,msg:e.errorMessage};r.createLog(i).then(function(e){s.success("Datele despre acest card au fost memorate pt. investigatii ulterioare.")})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})})["catch"](function(e){alert(JSON.stringify(e,null,4))})}else if(t.length>1)e.errorValidation=!0,e.errorMessage="Exista mai multe persoane cu acelasi card: "+e.obj.badgeCode+" ("+n+")";else if(t[0].eatSeries!==e.delivery.eatSeries)e.errorValidation=!0,"completed"===t[0].status?e.errorMessage="Posesorul acestui card a mancat in "+t[0].eatSeries+".":e.errorMessage="Posesorul acestui card a fost programat in "+t[0].eatSeries+".";else{if(e.errorValidation=!1,e.orderLine=t[0],"completed"!==e.orderLine.status){var i={};angular.copy(e.orderLine,i),i.status="completed",i.deliveryDate=new Date,a.update(i).then(function(t){e.deliverySummary=t.data,s.success("Livrarea a fost inregistrata!")})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})}y(e.orderLine)}e.obj.badgeCode="",e.obj.isFocusOnBadge=!0})["catch"](function(e){alert(JSON.stringify(e,null,4))})},e.revoke=function(t){t.status="open",delete t.deliveryDate,a.update(t).then(function(t){s.success("Livrarea a fost anulata!"),e.orderLine=void 0,e.obj.isFocusOnBadge=!0,e.deliverySummary=t.data})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})},e.badgesFilter=function(t){return e.obj.onlyNoBadges?!t.badgeCode:!0},e.selectPreference=function(t){"Toate pref."===t?e.selectedPreference="Toate pref.":e.selectedPreference=t},e.preferencesFilter=function(t){return"Toate pref."===e.selectedPreference?!0:"A"===e.selectedPreference||"B"===e.selectedPreference?t.option1===e.selectedPreference:"C"===e.selectedPreference||"D"===e.selectedPreference?t.option2===e.selectedPreference:"Fara pref."===e.selectedPreference?!(t.option1&&t.option2):void 0}}]),app.config(["$routeProvider",function(e){e.when("/admin/deliveries",{controller:"deliveriesController",templateUrl:"app/delivery/deliveries.html",title:"Livrari"}).when("/admin/deliveries/create",{controller:"deliveryController",templateUrl:"app/delivery/delivery.html",title:"Adauga o livrare"}).when("/admin/deliveries/:id",{controller:"deliveryController",templateUrl:"app/delivery/delivery.html",title:"Livrare",isEditMode:!0})}]),app.factory("deliveryService",["$http",function(e){var t={},r="/api/deliveries/";return t.create=function(t){return e.post(r,t)},t.createMany=function(t){return e.post(r+"rpc/createMany",t)},t.getAll=function(){return e.get(r).then(function(e){return e.data})},t.getById=function(t){return e.get(r+encodeURIComponent(t)).then(function(e){return e.data})},t.update=function(t){return e.put(r,t)},t["delete"]=function(t){return e["delete"](r+encodeURIComponent(t))},t.count=function(t,n){return e.get(r+"$count?$filter="+t+" eq '"+n+"'").then(function(e){return e.data})},t.createLog=function(t){return e.post(r+"rpc/createLog",t)},t}]),app.controller("openDeliveryLineTplController",["$scope","$uibModalInstance","helperService","deliveryService","helperValidator","$q","orderService","orderLineService","dataToModal",function(e,t,r,n,o,i,a,c,l){e.errors={},e.orderLine=l.orderLine,e.option1=l.option1,e.option2=l.option2,e.cancel=function(){t.dismiss("cancel")},e.update=function(r){e.orderLine.status="completed",e.orderLine.deliveryDate=new Date,c.update(e.orderLine).then(function(e){t.close()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})},e.revoke=function(){e.orderLine.status="open",delete e.orderLine.deliveryDate,c.update(e.orderLine).then(function(e){t.close()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})}}]),app.controller("dishController",["$scope","$route","dishService","$location",function(e,t,r,n){function o(){i()}function i(){r.getById(t.current.params.id).then(function(t){e.dish=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.dish={},e.isEditMode&&o(),e.create=function(t){e.submitted=!0,t.$valid&&r.create(e.dish).then(function(t){e.goBack()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})},e.update=function(t){e.submitted=!0,t.$valid&&r.update(e.dish).then(function(t){e.goBack()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})}}]),app.config(["$routeProvider",function(e){e.when("/admin/dishes",{controller:"dishesController",templateUrl:"app/dish/dishes.html",title:"Feluri de mancare"}).when("/admin/dishes/create",{controller:"dishController",templateUrl:"app/dish/dish.html",title:"Adauga un fel de mancare"}).when("/admin/dishes/:id",{controller:"dishController",templateUrl:"app/dish/dish.html",title:"Editeaza felul de mancare",isEditMode:!0})}]),app.factory("dishService",["$http",function(e){var t={},r="/api/dishes/";return t.create=function(t){return e.post(r,t)},t.getAll=function(){return e.get(r).then(function(e){return e.data})},t.getById=function(t){return e.get(r+encodeURIComponent(t)).then(function(e){return e.data})},t.update=function(t){return e.put(r,t)},t["delete"]=function(t){return e["delete"](r+encodeURIComponent(t))},t}]),app.controller("dishesController",["$scope","$location","dishService","modalService",function(e,t,r,n){function o(){r.getAll().then(function(t){e.dishes=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.dishes=[],e.errors={},o(),e["delete"]=function(t){var o={bodyDetails:t.name};n.confirm(o).then(function(n){var o=0;for(o in e.dishes)if(e.dishes[o]._id===t._id)break;r["delete"](t._id).then(function(){e.dishes.splice(o,1)})["catch"](function(t){e.errors=JSON.stringify(t.data,null,4),alert(e.errors)})})},e.create=function(){t.path("/admin/dishes/create")},e.refresh=function(){o()},e.showModal=function(e){var t={imageUrl:e.imageUrl};n.showImage(t).then(function(e){})}}]),app.controller("homeController",["$scope",function(e){}]),app.config(["$routeProvider",function(e){e.when("/admin",{controller:"homeController",templateUrl:"app/home/home.html",authenticate:!0})}]),app.controller("addDishToMenuTplController",["$scope","$uibModalInstance","dataToModal","helperService","dishService",function(e,t,r,n,o){function i(){o.getAll().then(function(t){e.dishes=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.dishes=[],e.ok=function(){t.close("aaa")},e.cancel=function(){t.dismiss("cancel")},i()}]),app.controller("addToMenuController",["$scope","$route","$location","helperService","dishService","menuService",function(e,t,r,n,o,i){function a(){i.getById(t.current.params.id).then(function(t){e.menu=t,e.roMenuDate=n.getStringFromString(t.menuDate)})["catch"](function(e){alert(JSON.stringify(e,null,4))})}function c(){o.getAll().then(function(t){e.dishes=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function l(){c(),a()}e.categories=[{value:0,name:"Toate felurile"},{value:1,name:"Supa"},{value:2,name:"Felul 2"},{value:3,name:"Salata"},{value:4,name:"Desert"}],e.menu={},e.selectedCategory=e.categories[0],e.isFastingSelected=!1,e.selectCategory=function(t){e.selectedCategory=t},e.dishes=[],l(),e.status={isopen:!1},e.addToMenu=function(t){var r=_.filter(e.menu.dishes,{category:t.category});if(r&&r.length>=2)return alert("Exista deja doua mancaruri din felul "+t.category+"."),!1;var n={};angular.copy(t,n),"1"!==t.category&&"2"!==t.category||(n.option=u(r,t)),void 0===e.menu.dishes&&(e.menu.dishes=[]),e.menu.dishes.push(n),i.update(e.menu).then(function(e){t.isAddedTmp=!0,a()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})},e.removeFromMenu=function(t){_.remove(e.menu.dishes,function(e){return e._id===t._id}),i.update(e.menu).then(function(e){delete t.isAddedTmp})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})};var u=function(e,t){var r="A";if("2"===t.category&&(r="C"),void 0===e||0===e.length)return r;var n=e[0];return n.option===r?String.fromCharCode(r.charCodeAt(0)+1):String.fromCharCode(n.option.charCodeAt(0)-1)};e.refresh=function(){l()}}]),app.controller("createMenuTplController",["$scope","$uibModalInstance","dataToModal","helperService",function(e,t,r,n){e.menuDate=n.getDateFromString(r),e.menuDate.setDate(e.menuDate.getDate()+1),e.ok=function(){t.close(e.menuDate)},e.cancel=function(){t.dismiss("cancel")},e.dateOptions={startingDay:1},e.isOpen=!1,e.open=function(){e.isOpen=!0}}]),app.controller("menuController",["$scope","$route","menuService","$location",function(e,t,r,n){function o(){i()}function i(){r.getById(t.current.params.id).then(function(t){e.menu=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.menu={},e.isEditMode&&o(),e.create=function(t){e.submitted=!0,t.$valid&&r.create(e.menu).then(function(e){n.path("/admin/menus")})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})},e.update=function(t){e.submitted=!0,t.$valid&&r.update(e.menu).then(function(e){n.path("/admin/menus")})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})}}]),app.controller("menuItemController",["$scope","$route","menuService","helperService",function(e,t,r,n){function o(){i()}function i(){r.getById(t.current.params.menuId).then(function(r){e.menu=r,e.menuDateAsString=a(e.menu.menuDate).dateAsShortString,e.dish=_.find(r.dishes,"_id",t.current.params.dishId)})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function a(e){return n.getObjFromString(e)}e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.menu={},e.dish={},e.isEditMode&&o(),e.update=function(t){e.submitted=!0,t.$valid&&r.update(e.menu).then(function(t){e.goBack()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})}}]),app.config(["$routeProvider",function(e){e.when("/admin/menus",{controller:"menusController",templateUrl:"app/menu/menus.html",title:"Meniuri"}).when("/admin/menus/create",{controller:"menuController",templateUrl:"app/menu/menu.html",title:"Adauga meniu"}).when("/admin/menus/:id",{controller:"menuController",templateUrl:"app/menu/menu.html",title:"Editeaza meniu",isEditMode:!0}).when("/admin/menus/:id/add",{controller:"addToMenuController",templateUrl:"app/menu/addToMenu.html",title:"Adauga la meniu",isEditMode:!0}).when("/admin/menus/:menuId/dishes/:dishId",{controller:"menuItemController",templateUrl:"app/menu/menuItem.html",title:"Editeaza produsul din meniu",isEditMode:!0})}]),app.factory("menuService",["$http","helperService",function(e,t){var r={},n="/api/menus/";return r.create=function(t){return e.post(n,t)},r.getAll=function(){return e.get(n).then(function(e){return e.data})},r.getNextMenus=function(){return e.get(n+"nextMenus/").then(function(e){return e.data})},r.getActiveMenus=function(){var r=t.getStringFromDate(new Date);return e.get(n+"rpc/getActiveMenus?today="+r).then(function(e){return e.data})},r.getById=function(t){return e.get(n+encodeURIComponent(t)).then(function(e){return e.data})},r.getMenu=function(t){var r="?$filter=menuDate eq '"+t+"'";return e.get(n+r).then(function(e){return e.data})},r.update=function(t){return e.put(n,t)},r["delete"]=function(t){return e["delete"](n+encodeURIComponent(t))},r}]),app.controller("menusController",["$scope","$location","menuService","modalService","helperService","$uibModal",function(e,t,r,n,o,i){function a(){r.getActiveMenus().then(function(t){e.menus=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.menus=[],e.errors={},e.friendlyDate=function(e){return o.getStringFromString(e)},a(),e.deleteDishFromMenu=function(t,o){var i={bodyDetails:t.name};n.confirm(i).then(function(n){_.remove(o.dishes,function(e){return e._id===t._id}),r.update(o).then(function(t){e.refresh()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})})},e.deleteMenu=function(t){var o={bodyDetails:"Meniul de "+e.friendlyDate(t.menuDate)};n.confirm(o).then(function(n){r["delete"](t._id).then(function(){e.refresh()})["catch"](function(t){e.errors=JSON.stringify(t.data,null,4),alert(e.errors)})})},e.openCreateMenu=function(){var t=_.chain(e.menus).sortBy("menuDate").last().value(),r=t&&t.menuDate||o.getStringFromDate(new Date),n=i.open({animation:!1,templateUrl:"app/menu/createMenuTpl.html",controller:"createMenuTplController",resolve:{dataToModal:function(){return r}}});n.result.then(function(t){var r=o.getStringFromDate(t);e.create(r)},function(){})},e.create=function(t){var n={menuDate:t};r.create(n).then(function(t){e.refresh()})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})},e.refresh=function(){a()},e.addToMenu=function(e){t.path("/admin/menus/"+e._id+"/add/")}}]),app.controller("navbarController",["$scope","$location","navbarService","$window","userService","$rootElement",function(e,t,r,n,o,i){function a(){var t=i.attr("ng-app"),o=t+"_buildInfo",a=angular.fromJson(n.sessionStorage.getItem(o));a?e.buildInfo=a:r.getAll().then(function(t){e.buildInfo=t,n.sessionStorage.setItem(o,angular.toJson(t))})["catch"](function(e){alert(JSON.stringify(e,null,4))})}e.menu=[{title:"Meniul de astazi",link:"/admin/todayMenu"},{title:"Meniurile viitoare",link:"/admin/nextMenus"},{title:"Contact",link:"/admin/contact"}],e.isCollapsed=!0,e.isLoggedIn=o.isLoggedIn,e.isAdmin=o.isAdmin,e.getCurrentUser=o.getCurrentUser,e.buildInfo={},a(),e.logout=function(){o.logout()},e.isActive=function(e){return e===t.path()}}]),app.factory("navbarService",["$http",function(e){var t={},r="/api/buildInfo/";return t.getAll=function(){return e.get(r).then(function(e){return e.data})},t}]),app.controller("nextMenusController",["$scope","$location","menuService","helperService",function(e,t,r,n){function o(){r.getNextMenus().then(function(t){e.menus=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.menus=[],e.errors={},e.friendlyDate=function(e){return n.getStringFromString(e)},o()}]),app.controller("nextMenusItemController",["$scope","$route","menuService",function(e,t,r){function n(){o()}function o(){r.getById(t.current.params.menuId).then(function(r){e.menu=r,e.dish=_.find(r.dishes,"_id",t.current.params.dishId)})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.menu={},e.dish={},n()}]),app.config(["$routeProvider",function(e){e.when("/admin/nextMenus",{controller:"nextMenusController",templateUrl:"app/nextMenus/nextMenus.html",title:"Meniurile viitoare"}).when("/admin/nextMenus/:menuId/dishes/:dishId",{controller:"nextMenusItemController",templateUrl:"app/nextMenus/nextMenusItem.html",title:"Detalii produs"})}]),app.controller("createOrderTplController",["$scope","$uibModalInstance","helperService","orderService","helperValidator","$q",function(e,t,r,n,o,i){function a(e,t){var r=i.defer(),n="order";return o.setAllFildsAsValid(t),o.requiredDate(e,t,n,"date"),t.$invalid?(r.resolve(),r.promise):(c(t).then(function(){r.resolve()}),r.promise)}e.errors={},e.order={date:new Date},e.minDate=new Date,e.create=function(o){a(e,o).then(function(){return o.$invalid?!1:(e.order.date=r.getStringFromDate(e.order.date),void n.create(e.order).then(function(e){t.close()})["catch"](function(e){}))})};var c=function(t){var a=i.defer(),c=r.getStringFromDate(e.order.date);return n.count("date",c).then(function(r){if(r>0){var n=[{field:"date",msg:"Exista deja o comanda pentru aceasta data."}];o.updateValidity(e,t,n)}a.resolve()})["catch"](function(e){alert(JSON.stringify(e,null,4)),a.reject()}),a.promise};e.cancel=function(){t.dismiss("cancel")},e.dateOptions={startingDay:1},e.isOpen=!1,e.open=function(){e.isOpen=!0}}]),app.controller("orderController",["$scope","$route","orderService","$location","helperValidator","helperService",function(e,t,r,n,o,i){function a(){c()}function c(){r.getById(t.current.params.id).then(function(t){e.order=t,e.dateAsShortString=l(e.order.date).dateAsShortString})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function l(e){return i.getObjFromString(e)}e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.errors={},e.order={},e.isEditMode&&a(),e.create=function(t){r.create(e.order).then(function(e){n.path("/admin/orders")})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))})},e.update=function(t){r.update(e.order).then(function(e){n.path("/admin/orders")})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))})}}]),app.config(["$routeProvider",function(e){e.when("/admin/orders",{controller:"ordersController",templateUrl:"app/order/orders.html",title:"Comenzi"}).when("/admin/orders/create",{controller:"orderController",templateUrl:"app/order/order.html",title:"Adauga o comanda"}).when("/admin/orders/:id",{controller:"orderController",templateUrl:"app/order/order.html",title:"Comanda",isEditMode:!0})}]),app.factory("orderService",["$http",function(e){var t={},r="/api/orders/";return t.count=function(t,n){return e.get(r+"$count?$filter="+t+" eq '"+n+"'").then(function(e){return e.data})},t.getAllOpen=function(){var t="?$filter=status eq 'open'";return e.get(r+t).then(function(e){return e.data})},t.create=function(t){return e.post(r,t)},t.getAll=function(){return e.get(r).then(function(e){return e.data})},t.getById=function(t){return e.get(r+t).then(function(e){return e.data})},t.update=function(t){return e.put(r,t)},t["delete"]=function(t){return e["delete"](r+t)},t.getEatSeriesList=function(t){return e.get(r+t+"/rpc/getEatSeriesList").then(function(e){return e.data})},t.getDeliverySummary=function(t,n){return e.get(r+t+"/rpc/getDeliverySummary/"+encodeURIComponent(n)).then(function(e){return e.data})},t}]),app.controller("ordersController",["$scope","$location","orderService","modalService","helperService","$uibModal",function(e,t,r,n,o,i){function a(){r.getAll().then(function(t){e.orders=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.orders=[],e.errors={},a(),e["delete"]=function(t){var o={bodyDetails:t.name};n.confirm(o).then(function(n){var o=0;for(o in e.orders)if(e.orders[o]._id===t._id)break;r["delete"](t._id).then(function(){e.orders.splice(o,1)})["catch"](function(t){e.errors=JSON.stringify(t.data,null,4),alert(e.errors)})})},e.openCreateOrder=function(){var t=i.open({animation:!1,templateUrl:"app/order/createOrderTpl.html",controller:"createOrderTplController"});t.result.then(function(){e.refresh()},function(){})},e.refresh=function(){a()},e.dt=function(e){return o.getObjFromString(e)}}]),app.controller("preferenceController",["$scope","$route","preferenceService","$location","helperValidator","menuService","customerEmployeeService","helperService","toastr",function(e,t,r,n,o,i,a,c,l){function u(){s()}function s(){r.getById(t.current.params.id).then(function(t){e.preference=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function d(t){r.getNextByEmployee(t).then(function(t){e.nextEmployeePreferences=t,e.preferences=[];var r=!0;e.menus.forEach(function(n,o){var i=_.find(t,{date:n.menuDate}),a=!!i,c=_.chain(n.dishes).filter({category:"1"}).map("option").uniq().sortBy().value(),l=_.chain(n.dishes).filter({category:"2"}).map("option").uniq().sortBy().value(),u=!1,s=!1;!a&&r&&(c.length>0?(u=!0,r=!1):l.length>0&&(s=!0,r=!1));var d={alreadyAdded:a,date:n.menuDate,option1:i?i.option1:"",option2:i?i.option2:"",availableForOption1:c,availableForOption2:l,isFocusOnOption1:u,isFocusOnOption2:s,rowIndex:o};e.preferences.push(d)})})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function f(){a.getAll().then(function(t){e.customerEmployees=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function p(){i.getActiveMenus().then(function(t){e.menus=t,e.menuIsReady=!0})["catch"](function(e){alert(JSON.stringify(e,null,4))})}function m(e,t){o.setAllFildsAsValid(t),e.preferencesHaveErrors=!1;var r=!1;return e.preferences.some(function(n){if(!n.alreadyAdded){var o=n.option1.toUpperCase();if(1===o.length&&(r=!0,-1===n.availableForOption1.indexOf(o))){var i=2*n.rowIndex,a="input"+i.toString();return t[a].$setValidity("myValidation",!1),e.errors.preferences="Ai introdus un cod invalid.",e.preferencesHaveErrors=!0,!0}var c=n.option2.toUpperCase();if(1===c.length&&(r=!0,-1===n.availableForOption2.indexOf(c))){var l=2*n.rowIndex+1,u="input"+l.toString();return t[u].$setValidity("myValidation",!1),e.errors.preferences="Ai introdus un cod invalid.",e.preferencesHaveErrors=!0,!0}}}),r||(e.form.$invalid=!0,e.errors.preferences="Nu ai adaugat optiuni noi.",e.preferencesHaveErrors=!0),e.preferencesHaveErrors}e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.errors={},e.preference={},e.person={},e.customerEmployees=[],e.menus=[],e.nextEmployeePreferences=[],e.selectEmployee=function(t,r){e.preferencesHaveErrors=!1,d(t.name)},e.isEditMode?u():(p(),f()),e.preferences=[],e.create=function(t){if(m(e,t),t.$invalid)return!1;var n=[];e.preferences.forEach(function(t){if(!t.alreadyAdded&&(""!==t.option1||""!==t.option2)){var r={employeeName:e.person.selected.name,date:t.date};""!==t.option1&&(r.option1=t.option1.toUpperCase()),""!==t.option2&&(r.option2=t.option2.toUpperCase()),n.push(r)}}),r.createMany(n).then(function(t){l.success("Inregistrarea a fost adaugata!"),e.person.selected=void 0,e.$broadcast("SetFocus")})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))})},e.update=function(t){r.update(e.preference).then(function(e){n.path("/admin/preferences")})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))})},e.dt=function(e){return c.getObjFromString(e)}}]),app.directive("moveNextOnMaxlength",function(){return{restrict:"A",link:function(e,t){t.on("input",function(e){if(t.val().length==t.attr("maxlength")){for(var r=t[0].id,n=parseInt(r)+1,o=angular.element(document.getElementById(n.toString()));o.length&&o[0].disabled;)r=o[0].id,n=parseInt(r)+1,o=angular.element(document.getElementById(n.toString()));o.length&&o[0].focus()}})}}}),app.config(["$routeProvider",function(e){e.when("/admin/preferences",{controller:"preferencesController",templateUrl:"app/preference/preferences.html",title:"Preferinte",reloadOnSearch:!1}).when("/admin/preferences/create",{controller:"preferenceController",templateUrl:"app/preference/addPreferences.html",title:"Adauga preferinte"}).when("/admin/preferences/:id",{controller:"preferenceController",templateUrl:"app/preference/preference.html",title:"Editeaza preferinte",isEditMode:!0})}]),app.factory("preferenceService",["$http","helperService",function(e,t){var r={},n="/api/preferences/";return r.create=function(t){return e.post(n,t)},r.createMany=function(t){return e.post(n+"rpc/createMany",t)},r.getByDate=function(t){return e.get(n+"?$filter=date eq '"+t+"'").then(function(e){return e.data})},r.getById=function(t){return e.get(n+encodeURIComponent(t)).then(function(e){return e.data;
})},r.getNextDates=function(){var r=t.getStringFromDate(new Date);return e.get(n+"rpc/getNextDates?today="+r).then(function(e){return e.data})},r.getNextByEmployee=function(r){var o=t.getStringFromDate(new Date),i="?$filter=employeeName eq '"+r+"' and date gt '"+o+"'";return e.get(n+i).then(function(e){return e.data})},r.getByEmployeeAndDate=function(t,r){var o="?$filter=employeeName eq '"+t+"' and date eq '"+r+"'";return e.get(n+o).then(function(e){return e.data})},r.update=function(t){return e.put(n,t)},r["delete"]=function(t){return e["delete"](n+encodeURIComponent(t))},r}]),app.controller("preferencesController",["$scope","$location","preferenceService","modalService","helperService",function(e,t,r,n,o){function i(){r.getNextDates().then(function(r){e.nextDates=r;var n=t.search();n.date?e.selectedDate=n.date:0===e.nextDates.length?e.nextDates.push("Nu exista date"):e.selectedDate=e.nextDates[0],e.selectedDate&&a(e.selectedDate)})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.preferences=[],e.errors={},e.nextDates=[],i(),e.selectDate=function(r){"Nu exista date"!==r&&(e.selectedDate=r,t.search("date",r),a(e.selectedDate))},e["delete"]=function(t){var o={bodyDetails:t.name};n.confirm(o).then(function(n){var o=0;for(o in e.preferences)if(e.preferences[o]._id===t._id)break;r["delete"](t._id).then(function(){e.preferences.splice(o,1)})["catch"](function(t){e.errors=JSON.stringify(t.data,null,4),alert(e.errors)})})},e.create=function(){t.path("/admin/preferences/create")},e.refresh=function(){i()};var a=function(t){r.getByDate(t).then(function(t){e.preferences=t})["catch"](function(e){alert(JSON.stringify(e,null,4))})};e.dt=function(e){return o.getObjFromString(e)}}]),app.controller("todayMenuController",["$scope","menuService","helperService",function(e,t,r){e.todaysMenu={},e.today=r.getFriendlyDate(new Date);var n=function(){var r=e.today.ymd;t.getMenu(r).then(function(t){e.todaysMenu=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})},o=function(){n()};o()}]),app.config(["$routeProvider",function(e){e.when("/admin/todayMenu",{controller:"todayMenuController",templateUrl:"app/todayMenu/todayMenu.html"})}]),app.controller("userController",["$scope","$route","userService","$location","helperValidator","toastr",function(e,t,r,n,o,i){function a(){c()}function c(){r.getById(t.current.params.id).then(function(t){e.user=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function l(e,t){var r="user";o.setAllFildsAsValid(t),o.required50(e,t,r,"name"),o.requiredEmail(e,t,r,"email")}e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.user={},e.errors={},e.isEditMode&&a(),e.create=function(t){return l(e,t),t.$invalid?!1:void r.create(e.user).then(function(t){e.goBack()})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))})},e.update=function(t){e.submitted=!0,t.$valid&&r.update(e.user).then(function(e){n.path("/admin/users")})["catch"](function(e){alert(JSON.stringify(e.data,null,4))})}}]),app.config(["$routeProvider",function(e){e.when("/admin/users",{controller:"usersController",templateUrl:"app/user/users.html",title:"Utilizatori"}).when("/admin/users/create",{controller:"userController",templateUrl:"app/user/user.html",title:"Adauga utilizator"}).when("/admin/users/:id",{controller:"userController",templateUrl:"app/user/user.html",title:"Editeaza utilizator",isEditMode:!0}).when("/admin/login",{controller:"loginController",templateUrl:"app/user/login/login.html",title:"Autentificare"}).when("/admin/register",{controller:"registerController",templateUrl:"app/user/register/register.html",title:"Inregistrare"}).when("/admin/changePassword",{controller:"changePasswordController",templateUrl:"app/user/changePassword/changePassword.html",title:"Schimba parola",authenticate:!0}).when("/admin/resetpassword",{controller:"resetPasswordController",templateUrl:"app/user/resetPassword/forgotPassword.html",title:"Reseteaza parola"}).when("/admin/resetpassword:ptoken",{controller:"resetPasswordController",templateUrl:"app/user/resetPassword/resetPassword.html",title:"Reseteaza parola"})}]),app.factory("userService",["$http","$cookies","$q","$window",function(e,t,r,n){var o={},i="/api/users/";o.create=function(t){return e.post(i,t)},o.getAll=function(){return e.get(i).then(function(e){return e.data})},o.getById=function(t){return e.get(i+encodeURIComponent(t)).then(function(e){return e.data})},o.update=function(t){return e.put(i,t)},o["delete"]=function(t){return e["delete"](i+encodeURIComponent(t))};var a={};return t.get("user")&&(a=angular.fromJson(t.get("user"))),o.changePassword=function(t,r){return e.put(i+"me/changepassword",{oldPassword:t,newPassword:r})},o.login=function(t,n){var o=n||angular.noop,i=r.defer();return e.post("/login",{email:t.email,password:t.password}).success(function(e){return a=e,i.resolve(e),o()}).error(function(e){return this.logout(),i.reject(e),o(e)}.bind(this)),i.promise},o.logout=function(){n.location.href="/logout"},o.getCurrentUser=function(){return a},o.isLoggedIn=function(){return a.hasOwnProperty("role")},o.isAdmin=function(){return"admin"===a.role},o}]),app.controller("usersController",["$scope","$http","userService","modalService","$location","$window",function(e,t,r,n,o,i){function a(){r.getAll().then(function(t){t.forEach(function(e){e.activationToken?e.status="asteapta activare":e.status="activ"}),e.users=t})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}a(),e.refresh=function(){a()},e.create=function(){o.path("/admin/users/create")},e["delete"]=function(t){var o={bodyDetails:t.name};n.confirm(o).then(function(n){r["delete"](t._id),angular.forEach(e.users,function(r,n){r===t&&e.users.splice(n,1)}),r.getCurrentUser().name===t.name&&(r.logout(),i.location.href="/")})},e.mySearch=function(t){var r=!1;return e.search?(new RegExp(e.search,"i").test(t.name)||new RegExp(e.search,"i").test(t.email))&&(r=!0):r=!0,r}}]),app.directive("lmCollapse",[function(){return{link:function(e,t,r){function n(){t.removeClass("collapsing").addClass("collapse in").css({height:"auto"})}function o(){t.css({height:"0"}),t.removeClass("collapsing").addClass("collapse")}e.$watch(r.lmCollapse,function(e){e?o():n()})}}}]),app.directive("lmFocus",["$timeout",function(e){return{restrict:"A",link:function(t,r,n){"true"===n.lmFocus||""===n.lmFocus?e(function(){r[0].focus()},0):(t.$watch(n.lmFocus,function(t,n){e(function(){t&&r[0].focus()},0)}),r.bind("blur",function(r){e(function(){t.$apply(n.lmFocus+"=false")},0)}),r.bind("focus",function(r){e(function(){t.$apply(n.lmFocus+"=true")},0)}))}}}]),app.directive("myMatch",function(){return{require:"ngModel",restrict:"A",scope:{match:"="},link:function(e,t,r,n){e.$watch(function(){return n.$pristine&&angular.isUndefined(n.$modelValue)||e.match===n.$modelValue},function(e){n.$setValidity("match",e)})}}}),app.directive("stopEmailValidation",function(){var e=/./;return{require:"ngModel",restrict:"",priority:2,link:function(t,r,n,o){o&&o.$validators.email&&(o.$validators.email=function(t){return o.$isEmpty(t)||e.test(t)})}}}),angular.module("ngLocale",[],["$provide",function(e){var t={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};e.value("$locale",{DATETIME_FORMATS:{AMPMS:["AM","PM"],DAY:["duminică","luni","marți","miercuri","joi","vineri","sâmbătă"],MONTH:["ianuarie","februarie","martie","aprilie","mai","iunie","iulie","august","septembrie","octombrie","noiembrie","decembrie"],SHORTDAY:["Du","Lu","Ma","Mi","Jo","Vi","Sâ"],SHORTMONTH:["ian.","feb.","mar.","apr.","mai","iun.","iul.","aug.","sept.","oct.","nov.","dec."],fullDate:"EEEE, d MMMM y",longDate:"d MMMM y",medium:"dd.MM.yyyy HH:mm:ss",mediumDate:"dd.MM.yyyy",mediumTime:"HH:mm:ss","short":"dd.MM.yyyy HH:mm",shortDate:"dd.MM.yyyy",shortTime:"HH:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"RON",DECIMAL_SEP:",",GROUP_SEP:".",PATTERNS:[{gSize:3,lgSize:3,macFrac:0,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,macFrac:0,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ro-ro",pluralCat:function(e){return 1==e?t.ONE:0==e||1!=e&&e==(0|e)&&e%100>=1&&19>=e%100?t.FEW:t.OTHER}})}]),app.factory("authInterceptor",["$rootScope","$q","$cookies","$location","$window",function(e,t,r,n,o){return{responseError:function(e){return 401===e.status?(n.path("/admin/login"),t.reject(e)):t.reject(e)}}}]),app.factory("helperService",[function(){var e={};return e.getRoDay=function(e){return 0===e?"Duminica":1===e?"Luni":2===e?"Marti":3===e?"Miercuri":4===e?"Joi":5===e?"Vineri":6===e?"Sambata":void 0},e.getRoShortDay=function(e){return 0===e?"Du":1===e?"Lu":2===e?"Ma":3===e?"Mi":4===e?"Jo":5===e?"Vi":6===e?"Sa":void 0},e.getRoMonth=function(e){return 0===e?"Ianuarie":1===e?"Februari":2===e?"Martie":3===e?"Aprilie":4===e?"Mai":5===e?"Iunie":6===e?"Iulie":7===e?"August":8===e?"Septembrie":9===e?"Octombrie":10===e?"Noiembrie":11===e?"Decembrie":void 0},e.getRoShortMonth=function(e){return 0===e?"Ian.":1===e?"Feb.":2===e?"Mar.":3===e?"Apr.":4===e?"Mai":5===e?"Iun.":6===e?"Iul.":7===e?"Aug.":8===e?"Sep.":9===e?"Oct.":10===e?"Nov.":11===e?"Dec.":void 0},e.getFriendlyDate=function(e){var t=e.getDate(),r=e.getMonth()+1,n=e.getFullYear(),o=t;10>o&&(o="0"+t);var i=r;return 10>i&&(i="0"+r),{dayAsString:this.getRoDay(e.getDay()),dayAsShortString:this.getRoShortDay(e.getDay()),dayOfMonth:o,monthAsString:this.getRoMonth(r-1),monthAsShortString:this.getRoShortMonth(r-1),year:n,ymd:n+"-"+i+"-"+o,dmy:o+"."+i+"."+n}},e.getDateFromString=function(e){var t=e.split("-"),r=t[1];return"0"===r[0]&&(r=r.charAt(1)),r-=1,new Date(t[0],r,t[2])},e.getStringFromString=function(e){var t=this.getDateFromString(e),r=this.getFriendlyDate(t),n=r.dayAsString+", "+r.dayOfMonth+" "+r.monthAsString+" "+r.year;return n},e.getObjFromString=function(e){var t=this.getDateFromString(e),r=this.getFriendlyDate(t);return{dayAsString:r.dayAsString,dayAsShortString:r.dayAsShortString,dayOfMonth:r.dayOfMonth,monthAsString:r.monthAsString,monthAsShortString:r.monthAsShortString,year:r.year,dateAsShortString:r.dayOfMonth+" "+r.monthAsShortString+" "+r.year}},e.getStringFromDate=function(e){return this.getFriendlyDate(e).ymd},e.makeId=function(e){for(var t="",r="abcdef0123456789",n=0;e>n;n+=1)t+=r.charAt(Math.floor(Math.random()*r.length));return t},e}]),app.service("helperValidator",[function(){function e(e,t,r,n){t[r].$setValidity("myValidation",!1),e.errors[r]=n}function t(e){var t=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(e)}function r(e){return void 0===e||""===e||null===e}this.required=function(t,n,o,i){t[o][i]=t[o][i]||"";var a=t[o][i];r(a)&&e(t,n,i,"Acest camp este obligatoriu.")},this.required50=function(t,n,o,i){t[o][i]=t[o][i]||"";var a=t[o][i];r(a)?e(t,n,i,"Acest camp este obligatoriu."):a.length>50&&e(t,n,i,"Maxim 50 caractere.")},this.requiredEmail=function(n,o,i,a){var c=n[i][a];r(c)?e(n,o,a,"Acest camp este obligatoriu."):t(c)?c.length>50&&e(n,o,a,"Maxim 50 caractere."):e(n,o,a,"Adresa de email invalida.")},this.optionalEmail=function(r,n,o,i){var a=r[o][i];a&&a.length>0&&!t(a)?e(r,n,i,"Adresa de email invalida."):a&&a.length>50&&e(r,n,i,"Maxim 50 caractere.")},this.optional50=function(t,r,n,o){var i=t[n][o];i&&i.length>50&&e(t,r,o,"Maxim 50 caractere.")},this.requiredDate=function(t,n,o,i){var a=t[o][i];r(a)?e(t,n,i,"Acest camp este obligatoriu."):a instanceof Date==!1?e(t,n,i,"Data invalida."):a.length>50&&e(t,n,i,"Maxim 50 caractere.")},this.updateValidity=function(t,r,n){angular.forEach(n,function(n,o){e(t,r,n.field,n.msg)})},this.setAllFildsAsValid=function(e){angular.forEach(e,function(e,t){0!==t.indexOf("$")&&angular.forEach(e.$error,function(t,r){e.$setValidity(r,null)})})}}]),app.service("modalService",["$uibModal",function(e){this.show=function(t,r){var n={},o={};return angular.extend(n,t),angular.extend(o,r),n.controller||(n.controller=["$scope","$uibModalInstance",function(e,t){e.modalOptions=o,e.modalOptions.ok=function(e){t.close(e)},e.modalOptions.close=function(e){t.dismiss("cancel")}}]),e.open(n).result},this.confirm=function(e){var t={animation:!1,templateUrl:"app/common/templates/confirm.html"},r={closeButtonText:"Renunta",actionButtonText:"Sterge",headerText:"Sterge",bodyTitle:"Esti sigur ca vrei sa stergi aceasta inregistrare?",bodyDetails:""};return angular.extend(r,e),this.show(t,r)},this.showImage=function(e){var t={templateUrl:"app/common/templates/showImage.html"};return this.show(t,e)}}]),app.controller("orderLineController",["$scope","$route","orderLineService","$location","helperValidator","customerEmployeeService","helperService","preferenceService","$q",function(e,t,r,n,o,i,a,c,l){function u(){s(),l.all([h,g]).then(function(t){e.obj.selectedEmployee=_.find(e.customerEmployees,{name:e.orderLine.employeeName})},function(e){alert("Failed: "+e)})}function s(){g=r.getById(e.orderLineId).then(function(t){e.orderLine=t,t.orderDate&&(e.orderDateAsString=p(t.orderDate).dateAsShortString),c.getByEmployeeAndDate(t.employeeName,t.orderDate).then(function(t){1===t.length&&(e.orderLine.option1=t[0].option1,e.orderLine.option2=t[0].option2,v=t[0])})})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function d(){h=i.getAll().then(function(t){e.customerEmployees=t})["catch"](function(e){alert(JSON.stringify(e,null,4))})}function f(e,t){var r="orderLine";o.setAllFildsAsValid(t),o.required50(e,t,r,"employeeName"),o.required50(e,t,r,"eatSeries")}function p(e){return a.getObjFromString(e)}function m(t,r){e.orderLine.option1&&(e.orderLine.option1=e.orderLine.option1.toUpperCase()),e.orderLine.option2&&(e.orderLine.option2=e.orderLine.option2.toUpperCase())}var h,g,v={};e.orderId=t.current.params.id,e.orderLineId=t.current.params.id2,e.obj={};var y=n.search();e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.errors={},e.orderLine={},e.customerEmployees=[],e.eatSeriesList=[{name:"Seria 1"},{name:"Seria 2"},{name:"Seria 3"}],d(),e.isEditMode?u():y.orderDate&&(e.orderLine.orderDate=y.orderDate,e.orderLine.orderId=e.orderId,e.orderDateAsString=p(y.orderDate).dateAsShortString),e.create=function(t){return f(e,t),t.$invalid?!1:(m(e.orderLine.option1,e.orderLine.option2),v&&v.option1&&e.orderLine.option1&&e.orderLine.option1.toLowerCase()===v.option1.toLowerCase()&&(e.orderLine.fromOwnerOpt1=!0),v&&v.option2&&e.orderLine.option2&&e.orderLine.option2.toLowerCase()===v.option2.toLowerCase()&&(e.orderLine.fromOwnerOpt2=!0),void r.create(e.orderLine).then(function(t){n.path("/admin/orders/"+e.orderId)})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))}))},e.update=function(t){return f(e,t),t.$invalid?!1:(m(e.orderLine.option1,e.orderLine.option2),v&&v.option1&&e.orderLine.option1&&e.orderLine.option1.toLowerCase()===v.option1.toLowerCase()?e.orderLine.fromOwnerOpt1=!0:delete e.orderLine.fromOwnerOpt1,v&&v.option2&&e.orderLine.option2&&e.orderLine.option2.toLowerCase()===v.option2.toLowerCase()?e.orderLine.fromOwnerOpt2=!0:delete e.orderLine.fromOwnerOpt2,void r.update(e.orderLine).then(function(t){n.path("/admin/orders/"+e.orderId)})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))}))},e.selectEmployee=function(t,r){e.orderLine.employeeName=e.obj.selectedEmployee.name,e.orderLine.badgeCode=e.obj.selectedEmployee.badgeCode,c.getByEmployeeAndDate(e.orderLine.employeeName,e.orderLine.orderDate).then(function(t){1===t.length?(e.orderLine.option1=t[0].option1,e.orderLine.option2=t[0].option2,v=t[0]):(e.orderLine.option1=void 0,e.orderLine.option2=void 0)})["catch"](function(e){alert(JSON.stringify(e,null,4))})}}]),app.controller("orderLineImportController",["$scope","$route","orderLineService","$location","helperValidator","helperService",function(e,t,r,n,o,i){function a(){c()}function c(){r.getById(e.orderLineId).then(function(t){e.orderLine=t,e.orderLine.orderDate&&(e.orderDateAsString=u(e.orderLine.orderDate).dateAsShortString)})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}function l(e,t){var r="importData";o.setAllFildsAsValid(t),o.required(e,t,r,"employeesName"),o.required50(e,t,r,"eatSeries")}function u(e){return i.getObjFromString(e)}e.orderId=t.current.params.id,e.orderLineId=t.current.params.id2;var s=n.search();e.isEditMode=t.current.isEditMode,e.isFocusOnName=!e.isEditMode,e.errors={},e.orderLine={},e.importData={},e.eatSeriesList=[{name:"Seria 1"},{name:"Seria 2"},{name:"Seria 3"}],e.isEditMode?a():s.orderDate&&(e.importData.orderDate=s.orderDate,e.importData.orderId=e.orderId,e.orderDateAsString=u(s.orderDate).dateAsShortString),e.create=function(t){return l(e,t),t.$invalid?!1:void r["import"](e.importData).then(function(t){n.path("/admin/orders/"+e.orderId)})["catch"](function(r){r.data.errors?o.updateValidity(e,t,r.data.errors):alert(JSON.stringify(r.data,null,4))})}}]),app.config(["$routeProvider",function(e){e.when("/admin/orders/:id/orderLines",{controller:"orderLinesController",templateUrl:"app/order/orderLine/orderLines.html",title:"Detalii comanda"}).when("/admin/orders/:id/orderLines/create",{controller:"orderLineController",templateUrl:"app/order/orderLine/orderLine.html",title:"Adauga o linie la comanda"}).when("/admin/orders/:id/orderLines/import",{controller:"orderLineImportController",templateUrl:"app/order/orderLine/orderLineImport.html",title:"Importa comanda"}).when("/admin/orders/:id/orderLines/:id2",{controller:"orderLineController",templateUrl:"app/order/orderLine/orderLine.html",title:"Editeaza linia de comanda",isEditMode:!0})}]),app.factory("orderLineService",["$http",function(e){var t={},r="/api/orderLines/";return t.getAll=function(t){var n="?$filter=orderId eq '"+t+"'";return e.get(r+n).then(function(e){return e.data})},t.getEatSeriesDetails=function(t,n){var o="?$filter=orderId eq '"+t+"' and eatSeries eq '"+n+"'";return e.get(r+o).then(function(e){return e.data})},t.getOrderLinesByBadge=function(t,n){var o="?$filter=orderId eq '"+t+"' and badgeCode eq '"+encodeURIComponent(n)+"'";return e.get(r+o).then(function(e){return e.data})},t.getOrderLinesBySeriesAndStatus=function(t,n,o){var i="?$filter=orderId eq '"+t+"' and eatSeries eq '"+n+"' and status eq '"+o+"'";return e.get(r+i).then(function(e){return e.data})},t.create=function(t){return e.post(r,t)},t.getById=function(t){return e.get(r+t).then(function(e){return e.data})},t.update=function(t){return e.put(r,t)},t["delete"]=function(t){return e["delete"](r+t)},t["import"]=function(t){return e.post(r+"rpc/import",t)},t}]),app.controller("orderLinesController",["$scope","$location","orderLineService","modalService","$route",function(e,t,r,n,o){function i(){r.getAll(e.orderId).then(function(r){e.orderLines=r,e.eatSeriesList=_.chain(e.orderLines).map("eatSeries").uniq().sortBy().value();var n=t.search();n.eatSeries?e.selectedEatSeries=n.eatSeries:e.selectedEatSeries="Toate seriile",n.preference?e.selectedPreference=n.preference:e.selectedPreference="Toate pref.",n.onlyNoBadges?e.obj.onlyNoBadges=!0:e.obj.onlyNoBadges=!1})["catch"](function(e){401!==e.status&&alert(JSON.stringify(e,null,4))})}e.orderId=o.current.params.id,e.orderLines=[],e.errors={},e.obj={},e.obj.onlyNoBadges=!1,e.selectOnlyNoBadges=function(){e.obj.onlyNoBadges===!1?(e.obj.onlyNoBadges=!0,t.search("onlyNoBadges",null)):(e.obj.onlyNoBadges=!1,t.search("onlyNoBadges",!0))},e.selectEatSeries=function(r){"Toate seriile"===r?(e.selectedEatSeries="Toate seriile",t.search("eatSeries",null)):(e.selectedEatSeries=r,t.search("eatSeries",r))},e.selectPreference=function(r){"Toate pref."===r?(e.selectPreference="Toate pref.",t.search("preference",null)):(e.selectPreference=r,t.search("preference",r))},e.preferences=["A","B","C","D"],i(),e["delete"]=function(t){var o={bodyDetails:t.name};n.confirm(o).then(function(n){var o=0;for(o in e.orderLines)if(e.orderLines[o]._id===t._id)break;r["delete"](t._id).then(function(){e.orderLines.splice(o,1)})["catch"](function(t){e.errors=JSON.stringify(t.data,null,4),alert(e.errors)})})},e.create=function(){t.path("/admin/orders/"+e.orderId+"/orderLines/create"),t.search("orderDate",e.order.date)},e["import"]=function(){t.path("/admin/orders/"+e.orderId+"/orderLines/import"),t.search("orderDate",e.order.date)},e.refresh=function(){i()},e.preferencesFilter=function(t){return"Toate pref."===e.selectedPreference?!0:"A"===e.selectedPreference||"B"===e.selectedPreference?t.option1===e.selectedPreference:"C"===e.selectedPreference||"D"===e.selectedPreference?t.option2===e.selectedPreference:"Fara pref."===e.selectedPreference?!(t.option1&&t.option2):void 0},e.badgesFilter=function(t){return e.obj.onlyNoBadges?!t.badgeCode:!0}}]),app.controller("changePasswordController",["$scope","userService",function(e,t){e.errors={},e.changePassword=function(r){e.submitted=!0,r.$valid&&t.changePassword(e.user.oldPassword,e.user.newPassword).then(function(){e.message="Parola a fost schimbata cu succes."})["catch"](function(){r.password.$setValidity("mongoose",!1),e.errors.other="Parola incorecta",e.message=""})}}]),app.controller("loginController",["$scope","userService","$location",function(e,t,r){e.user={},e.errors={},e.login=function(n){e.submitted=!0,n.$valid&&t.login({email:e.user.email,password:e.user.password}).then(function(){r.path("/admin/")})["catch"](function(t){e.errors.other=t.message})}}]),app.controller("registerController",["$scope","userService","$location",function(e,t,r){e.user={},e.errors={},e.register=function(n){e.submitted=!0,n.$valid&&t.create({name:e.user.name,email:e.user.email,password:e.user.password}).then(function(){r.path("/admin/")})["catch"](function(t){t=t.data,e.errors={},angular.forEach(t.errors,function(t,r){n[r].$setValidity("mongoose",!1),e.errors[r]=t.message})})}}]),app.controller("resetPasswordController",["$scope","userService",function(e,t){e.errors={},e.resetPassword=function(t){e.submitted=!0}}]);